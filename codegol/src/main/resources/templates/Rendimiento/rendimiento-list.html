<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="layout/menu.html">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Rendimiento - Escuela de Fútbol Pinze</title>
    <link rel="stylesheet" th:href="@{/css/style_pag_prin.css}" />
    <link rel="stylesheet" th:href="@{/css/stylepag.css}" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        .ventana-flotante {
            display: none;
            position: fixed;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            padding: 16px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
            z-index: 9999;
            max-width: 90%;
            max-height: 90%;
            overflow:auto;
            border-radius:8px;
        }
        .ventana-flotante.active { display: block; }
        .ver-mas { cursor: pointer; }
        .ventana-flotante .cerrar-detalle {
            background: transparent;
            border: none;
            font-size: 18px;
            cursor: pointer;
        }
        .ventana-flotante canvas {
            display:block;
            margin-top:12px;
            max-width:100%;
            height:auto;
        }
    </style>
</head>

<body>
<div layout:fragment="content">

    <!-- BARRA SUPERIOR (CORREGIDA LA RUTA) -->
    <!-- CONTENEDOR DE BOTONES COMO MATRÍCULA/PDF -->
    <div style="margin: 10px 0; display: flex; gap: 12px; align-items: center;">

        <!-- COLUMNA IZQUIERDA: Botón Registrar rendimiento -->
        <div style="flex: 1;">
            <a th:href="@{/rendimientos/nuevo}"
               class="boton-registrar"
               style="display: inline-block; width: 100%; text-align: center;">
                Registrar rendimiento
            </a>
        </div>

        <!-- COLUMNA DERECHA: Botón Buscar -->
        <div style="flex: 1; margin-left: 20px;">
            <form method="get" action="/rendimientos" style="margin: 0; display: flex; gap: 8px;">
                <input type="date" name="fecha" th:value="${fecha}" style="padding: 6px; border-radius: 5px; flex: 1;">
                <input type="text" name="posicion" placeholder="Posición..." th:value="${posicion}" style="padding: 6px; border-radius: 5px; flex: 1;">
                <button type="submit" class="boton-registrar" style="width: 100%;">Buscar</button>
            </form>
        </div>
    </div>


    <!-- TABLA -->
    <table>
        <thead>
        <tr>
            <th>ID</th>
            <th>Fecha</th>
            <th>Posición</th>
            <th>Velocidad</th>
            <th>Acciones</th>
        </tr>
        </thead>
        <tbody>
        <tr th:each="r : ${rendimientos}">
            <td th:text="${r.id_rendimiento}"></td>
            <td th:text="${r.fecha_evaluacion}"></td>
            <td th:text="${r.posicion}"></td>
            <td th:text="${r.velocidad}"></td>
            <td class="acciones">
                <button type="button" class="ver-mas" th:data-id="${r.id_rendimiento}">Ver más</button>

                <a style="color: inherit; text-decoration: none;"
                   th:href="@{/rendimientos/editar/{id}(id=${r.id_rendimiento})}">
                    <button type="button" class="actualizar">Actualizar</button>
                </a>

                <a style="color: inherit; text-decoration: none;"
                   th:href="@{/rendimientos/eliminar/{id}(id=${r.id_rendimiento})}">
                    <button type="button" class="eliminar">Eliminar</button>
                </a>
            </td>
        </tr>
        </tbody>
    </table>

    <!-- VENTANA FLOTANTE CON DATASETS CORREGIDOS -->
    <div th:each="r : ${rendimientos}"
         th:id="'detalle-usuario-' + ${r.id_rendimiento}"
         class="ventana-flotante"
         role="dialog"
         aria-hidden="true"

         th:data-velocidad="${r.velocidad}"
         th:data-potencia="${r.potencia_tiro}"
         th:data-defensa="${r.defensa}"
         th:data-regate="${r.regate}"
         th:data-pase="${r.pase}"
         th:data-tecnica="${r.tecnica}"
         th:data-promedio="${r.promedio}"
         th:data-observaciones="${r.observaciones}"
    >
        <button type="button" class="cerrar-detalle" style="float:right">Cerrar ×</button>

        <ul>
            <li><strong>ID Rendimiento:</strong> <span th:text="${r.id_rendimiento}"></span></li>
            <li><strong>Fecha Evaluación:</strong> <span th:text="${r.fecha_evaluacion}"></span></li>
            <li><strong>Posición:</strong> <span th:text="${r.posicion}"></span></li>
            <li><strong>Velocidad:</strong> <span th:text="${r.velocidad}"></span></li>
            <li><strong>Potencia Tiro:</strong> <span th:text="${r.potencia_tiro}"></span></li>
            <li><strong>Defensa:</strong> <span th:text="${r.defensa}"></span></li>
            <li><strong>Regate:</strong> <span th:text="${r.regate}"></span></li>
            <li><strong>Pase:</strong> <span th:text="${r.pase}"></span></li>
            <li><strong>Técnica:</strong> <span th:text="${r.tecnica}"></span></li>
            <li><strong>Promedio:</strong> <span th:text="${r.promedio}"></span></li>
            <li><strong>Observaciones:</strong> <span th:text="${r.observaciones}"></span></li>
            <li><strong>Estado:</strong> <span th:text="${r.estado} ? 'Activo' : 'Inactivo'"></span></li>
        </ul>

        <canvas th:id="'graficaRadarDetalle-' + ${r.id_rendimiento}" width="400" height="400"></canvas>
    </div>

</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {

        const charts = {};

        function toNum(v) {
            if (v === undefined || v === null) return 0;
            const n = parseFloat(String(v).trim());
            return Number.isFinite(n) ? n : 0;
        }

        document.addEventListener('click', (evt) => {
            const btn = evt.target.closest('.ver-mas');
            if (!btn) return;

            const id = btn.dataset.id;
            const ventana = document.getElementById('detalle-usuario-' + id);
            ventana.classList.add('active');
            ventana.setAttribute('aria-hidden', 'false');

            const cerrarBtn = ventana.querySelector('.cerrar-detalle');
            cerrarBtn.onclick = () => {
                ventana.classList.remove('active');
                ventana.setAttribute('aria-hidden','true');
            };

            const ds = ventana.dataset;
            const dataValues = [
                toNum(ds.velocidad),
                toNum(ds.potencia),
                toNum(ds.defensa),
                toNum(ds.regate),
                toNum(ds.pase),
                toNum(ds.tecnica)
            ];

            const canvasId = 'graficaRadarDetalle-' + id;
            const canvas = document.getElementById(canvasId);

            if (charts[canvasId]) charts[canvasId].destroy();

            const ctx = canvas.getContext('2d');
            charts[canvasId] = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Velocidad', 'Potencia Tiro', 'Defensa', 'Regate', 'Pase', 'Técnica'],
                    datasets: [{
                        label: 'Rendimiento',
                        data: dataValues,
                        backgroundColor: 'rgba(15, 88, 151, 0.2)',
                        borderColor: '#0f5897',
                        borderWidth: 2,
                        pointBackgroundColor: '#0f5897'
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        r: {
                            min: 0,
                            max: 100,
                            ticks: { stepSize: 20 }
                        }
                    }
                }
            });
        });

        window.addEventListener('click', (e) => {
            document.querySelectorAll('.ventana-flotante.active').forEach(v => {
                if (!v.contains(e.target)) {
                    v.classList.remove('active');
                    v.setAttribute('aria-hidden','true');
                }
            });
        });

        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                document.querySelectorAll('.ventana-flotante.active').forEach(v => {
                    v.classList.remove('active');
                    v.setAttribute('aria-hidden','true');
                });
            }
        });

    });
</script>

</body>
</html>
